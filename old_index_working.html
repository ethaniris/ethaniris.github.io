<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>分享連結</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 16px;
        text-align: center;
      }
      .url-box {
        background: #f5f5f5;
        padding: 12px;
        border-radius: 8px;
        margin: 16px 0;
        word-break: break-all;
      }
      button {
        padding: 12px 16px;
        margin: 12px 8px 0 0;
        border: 0;
        border-radius: 8px;
        background: #06c755;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      .hint {
        color: #666;
        font-size: 14px;
        margin-top: 8px;
      }
      #warn {
        color: #c00;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h3>要分享這個連結嗎？</h3>
    <div class="url-box" id="urlDisplay"></div>
    <div>
      <button id="share">分享給朋友</button>
      <div id="warn"></div>
      <p class="hint">
        若無法分享，請確認：用 LINE 開啟、已授權 chat_message.write。
      </p>
    </div>

    <script>
      const LIFF_ID = "2008383838-vLABV8zo"; // <-- replace

      // Preserve original URL (including ?url=...) across login redirects
      const originalUrl = location.href;

      // Read url param NOW, before any redirect
      const params = new URL(originalUrl).searchParams;
      const urlParam = params.get("url");

      function setUrlOrWarn(url) {
        const warn = document.getElementById("warn");
        const urlDisplay = document.getElementById("urlDisplay");
        if (!url) {
          warn.style.display = "block";
          warn.textContent = "沒有拿到分享連結 (url 參數)。";
        } else {
          urlDisplay.textContent = url;
        }
      }

      async function main() {
        // Show URL immediately based on current URL (even before LIFF init)
        setUrlOrWarn(urlParam);

        await liff.init({ liffId: LIFF_ID });

        // If not logged in, log in and come back to the same URL (keeps ?url=)
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: originalUrl });
          return; // stop here; the page will reload after login
        }

        const warn = document.getElementById("warn");

        // Check we're inside LINE client
        if (!liff.isInClient()) {
          warn.style.display = "block";
          warn.textContent = "請在 LINE 內開啟此頁面才能分享 (LIFF)。";
        }

        // Check API availability
        const canShare = liff.isApiAvailable("shareTargetPicker");

        // Share button
        document.getElementById("share").onclick = async () => {
          try {
            const url = new URL(location.href).searchParams.get("url");
            if (!url) {
              alert("缺少 url 參數，無法分享");
              return;
            }
            if (!canShare) {
              alert(
                "此環境不支援 shareTargetPicker，請用 LINE 開啟並確認已授權。"
              );
              return;
            }

            // Share the URL as a text message
            await liff.shareTargetPicker([
              {
                type: "text",
                text: "分享給您一個連結：\n" + url,
              },
            ]);

            if (liff.isInClient()) liff.closeWindow();
          } catch (e) {
            // If user cancels sharing, don't show error
            if (e.code !== "CANCEL") {
              alert("分享失敗：" + (e?.message || e));
            }
          }
        };
      }

      main();
    </script>
  </body>
</html>
