<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>分享 / 加入（同一個 LIFF 頁）</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 16px;
        text-align: center;
      }
      .box {
        background: #f5f5f5;
        padding: 12px;
        border-radius: 8px;
        margin: 16px 0;
        word-break: break-all;
      }
      button {
        padding: 12px 16px;
        margin: 8px;
        border: 0;
        border-radius: 8px;
        background: #06c755;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
      }
      .muted {
        color: #666;
        font-size: 14px;
        margin-top: 8px;
      }
      #warn {
        color: #c00;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h2 id="title">載入中…</h2>

    <div class="box" id="infoBox">請稍候</div>

    <div id="shareArea" style="display: none">
      <button id="shareBtn">分享邀請連結</button>
      <p class="muted">若無法分享，請用 LINE 開啟並授權 chat_message.write。</p>
    </div>

    <div id="joinArea" style="display: none">
      <button id="addBtn">去加好友</button>
      <p class="muted">已顯示你的 userId；你也可以關閉此頁。</p>
    </div>

    <div id="warn"></div>

    <script>
      const LIFF_ID = "2008383838-vLABV8zo"; // 👈 換成你的 LIFF ID
      const DEFAULT_ADD_FRIEND_URL = "https://line.me/R/ti/p/@638ccvfy"; // 例如 https://line.me/R/ti/p/@638ccvfy

      const originalUrl = location.href;
      const url = new URL(originalUrl);
      const params = url.searchParams;

      // 模式：mode=share（A 用） / mode=join（B 用）；若未帶，預設 share
      const mode = (params.get("mode") || "share").toLowerCase();

      // 若有指定加好友目標網址（可選），用 ?url= 傳入
      const addFriendUrl = params.get("url") || DEFAULT_ADD_FRIEND_URL;

      // 推薦者（只在 join 模式有可能帶到）
      const referrerId = params.get("ref") || null;

      function setWarn(msg) {
        const warn = document.getElementById("warn");
        warn.style.display = "block";
        warn.textContent = msg;
      }

      function showInfo(msg) {
        document.getElementById("infoBox").textContent = msg;
      }

      async function getViewerUserId() {
        // 1) 先嘗試用 ID Token (需要 openid)
        const decoded = liff.getDecodedIDToken && liff.getDecodedIDToken();
        if (decoded && decoded.sub) return decoded.sub;

        // 2) 在 LINE App 內可用 getProfile 備援
        if (liff.isInClient && liff.isInClient()) {
          try {
            const profile = await liff.getProfile();
            if (profile && profile.userId) return profile.userId;
          } catch (e) {}
        }
        return null;
      }

      async function ensureLogin() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          // 保留目前的 URL（含 ?mode=... 等）返回
          liff.login({ redirectUri: location.href });
          return false; // 這次流程到這裡結束，登入後會自動回來
        }
        return true;
      }

      async function runShareMode() {
        document.getElementById("title").textContent = "分享邀請";

        // 取得 A 的 userId，用於做 ref
        const aUserId = await getViewerUserId();
        if (!aUserId) {
          showInfo("⚠️ 拿不到你的 userId，請確認用 LINE 開啟且勾選 openid。");
          setWarn("若持續失敗，請檢查 LIFF 設定與 scope。");
          return;
        }

        // 構造要分享給朋友的「同一個 LIFF 頁（join 模式）」連結
        const inviteUrl = `https://liff.line.me/${LIFF_ID}?mode=join&ref=${encodeURIComponent(
          aUserId
        )}&url=${encodeURIComponent(addFriendUrl)}`;

        showInfo("將分享這個邀請連結：\n" + inviteUrl);

        const canShare =
          liff.isApiAvailable && liff.isApiAvailable("shareTargetPicker");
        document.getElementById("shareArea").style.display = "block";
        document.getElementById("shareBtn").onclick = async () => {
          try {
            if (!canShare) {
              alert(
                "此環境不支援 shareTargetPicker，請用 LINE 開啟並確認已授權。"
              );
              return;
            }
            await liff.shareTargetPicker([
              { type: "text", text: "幫我加一下官方帳號～\n" + inviteUrl },
            ]);
            if (liff.isInClient && liff.isInClient()) liff.closeWindow();
          } catch (e) {
            if (e?.code !== "CANCEL") alert("分享失敗：" + (e?.message || e));
          }
        };
      }

      async function runJoinMode() {
        document.getElementById("title").textContent = "加入前確認";

        // 取得 B 的 userId，並顯示出來
        const bUserId = await getViewerUserId();
        if (bUserId) {
          showInfo(
            "✅ 你的 LINE userId：\n" +
              bUserId +
              (referrerId ? `\n（邀請者 ref：${referrerId}）` : "")
          );
        } else {
          showInfo("⚠️ 拿不到你的 userId，請用 LINE 開啟或確認已授權 openid。");
          setWarn("若在外部瀏覽器，請先登入或改用 LINE 內開啟。");
        }

        // 提供「去加好友」按鈕
        document.getElementById("joinArea").style.display = "block";
        document.getElementById("addBtn").onclick = () => {
          location.href = addFriendUrl;
        };
      }

      async function main() {
        try {
          const ok = await ensureLogin();
          if (!ok) return; // 觸發登入，頁面會重新導回

          if (!liff.isInClient || !liff.isInClient()) {
            setWarn("提示：建議在 LINE App 內開啟，體驗較完整。");
          }

          if (mode === "join") {
            await runJoinMode();
          } else {
            // 預設 share
            await runShareMode();
          }
        } catch (e) {
          setWarn("初始化失敗：" + (e?.message || e));
        }
      }

      main();
    </script>
  </body>
</html>
